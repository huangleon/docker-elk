#{% set metrics_memory = "200Mi" -%}
#{% set eventer_memory = "200Mi" -%}
#{% set metrics_memory_per_node = 4 -%}
#{% set eventer_memory_per_node = 500 -%}
#{% set num_nodes = pillar.get('num_nodes', -1) -%}
#{% if num_nodes >= 0 -%}
#  {% set metrics_memory = (200 + num_nodes * metrics_memory_per_node)|string + "Mi" -%}
#  {% set eventer_memory = (200 * 1024 + num_nodes * eventer_memory_per_node)|string + "Ki" -%}
#{% endif -%}

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: efk-logging
  namespace: kube-system
  labels:
    k8s-app: efk-logging
#    kubernetes.io/cluster-service: "true"
    version: v1.0.0
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: efk-logging
      version: v1.0.0
  template:
    metadata:
      labels:
        k8s-app: efk-logging
        version: v1.0.0
    spec:
#      serviceAccountName: heapster
      containers:
        - image: elasticsearch:latest
          name: elasticsearch
#          resources:
#            # keep request = limit to keep this container in guaranteed class
#            limits:
#              cpu: 100m
#              memory: {{ metrics_memory }}
#            requests:
#              cpu: 100m
#              memory: {{ metrics_memory }}
#          command:
#            - elasticsearch
#            - -Des.network.host=0.0.0.0
          ports:
          - containerPort: 9200
            name: db
            protocol: TCP
          - containerPort: 9300
            name: transport
            protocol: TCP
#          volumeMounts:
#            - name: es-persistent-storage
#              mountPath: /data
        - image: kibana:5.0.0-alpha5
          name: kibana
          env:
            - name: ELASTICSEARCH_URL
              value: http://$(LOGGING_ELASTICSEARCH_SERVICE_HOST):$(LOGGING_ELASTICSEARCH_SERVICE_PORT)
          ports:
          - containerPort: 5601
            name: ui
            protocol: TCP

        - image: fluent/fluentd:ubuntu-base
          name: fluentd
          ports:
          - containerPort: 24224
            protocol: TCP
          - containerPort: 5140
            protocol: UDP
          volumeMounts:
            - name: fluentd-persistent-storage
              mountPath: /fluentd/log
      volumes:
      - name: fluentd-persistent-storage
        emptyDir: {}
      - name: es-persistent-storage
        emptyDir: {}

#        - image: gcr.io/google_containers/heapster:v1.0.2
#          name: eventer
#          resources:
#            # keep request = limit to keep this container in guaranteed class
#            limits:
#              cpu: 100m
#              memory: {{ eventer_memory }}
#            requests:
#              cpu: 100m
#              memory: {{ eventer_memory }}
#          command:
#            - /eventer
#            - --source=kubernetes:''
#            - --sink=influxdb:http://monitoring-influxdb:8086
#        - image: gcr.io/google_containers/addon-resizer:1.0
#          name: heapster-nanny
#          resources:
#            limits:
#              cpu: 50m
#              memory: 100Mi
#            requests:
#              cpu: 50m
#              memory: 100Mi
#          env:
#            - name: MY_POD_NAME
#              valueFrom:
#                fieldRef:
#                  fieldPath: metadata.name
#            - name: MY_POD_NAMESPACE
#              valueFrom:
#                fieldRef:
#                  fieldPath: metadata.namespace
#          command:
#            - /pod_nanny
#            - --cpu=100m
#            - --extra-cpu=0m
#            - --memory={{ metrics_memory }}
#            - --extra-memory={{ metrics_memory_per_node }}Mi
#            - --threshold=5
#            - --deployment=heapster-v1.0.2
#            - --container=heapster
#            - --poll-period=300000
#        - image: gcr.io/google_containers/addon-resizer:1.0
#          name: eventer-nanny
#          resources:
#            limits:
#              cpu: 50m
#              memory: 100Mi
#            requests:
#              cpu: 50m
#              memory: 100Mi
#          env:
#            - name: MY_POD_NAME
#              valueFrom:
#                fieldRef:
#                  fieldPath: metadata.name
#            - name: MY_POD_NAMESPACE
#              valueFrom:
#                fieldRef:
#                  fieldPath: metadata.namespace
#          command:
#            - /pod_nanny
#            - --cpu=100m
#            - --extra-cpu=0m
#            - --memory={{ eventer_memory }}
#            - --extra-memory={{ eventer_memory_per_node }}Ki
#            - --threshold=5
#            - --deployment=heapster-v1.0.2
#            - --container=eventer
#            - --poll-period=300000

